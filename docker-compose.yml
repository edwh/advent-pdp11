version: '3.8'

# Advent MUD - Docker Compose Configuration
#
# Before building:
#   1. Run: python3 scripts/build_disk.py
#   2. This generates patched disk images in build/disks/
#
# Then:
#   docker compose up -d --build
#
# Access:
#   - Web interface: http://localhost:8088
#   - Admin terminal: http://localhost:7682
#   - Telnet (console): telnet localhost 2324
#   - Telnet (terminal): telnet localhost 2325
#
# Note: Ports chosen to avoid conflicts with other services:
#   - 8088 instead of 8080 (traefik uses 8080)
#   - 2324/2325 instead of 2322/2323 (advent-ra72-test uses those)

services:
  advent:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: advent-mud
    ports:
      - "8088:8080"   # Web interface (nginx)
      - "7681:7681"   # Game web terminal (ttyd)
      - "7682:7682"   # Admin web terminal
      - "2324:2322"   # SIMH console (telnet)
      - "2325:2323"   # RSTS/E terminal lines (telnet)
    # Note: No volume mount for disks - using build-from-source workflow
    # Disk is restored from backup on each start to prevent corruption
    restart: unless-stopped
    healthcheck:
      # Use boot_status.json instead of connecting to console port
      # TCP connections to port 2322 create CLOSE-WAIT states that block SIMH
      test: ["CMD", "sh", "-c", "grep -q '\"status\": \"ready\"' /tmp/boot_status.json 2>/dev/null"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 600s  # Build takes 10-15 minutes
