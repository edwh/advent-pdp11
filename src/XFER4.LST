       1                                	.TITLE	XFER4 - Hex File Transfer with File I/O
       2                                	.IDENT	/V1.0/
       3                                ;
       4                                ;	XFER4 - Receive hex-encoded files and write to disk
       5                                ;	Based on working XFER3 with added RT-11 file I/O
       6                                ;
       7                                ;	Protocol:
       8                                ;	  :filename     - Start receiving file
       9                                ;	  :0000:HH...   - Hex data line
      10                                ;	  :END          - End of file
      11                                ;
      12                                ;	RT-11 Programmed Requests:
      13                                ;	  .ENTER (create file) - EMT 375, code 4
      14                                ;	  .WRITW (write wait)  - EMT 375, code 30
      15                                ;	  .CLOSE (close file)  - EMT 375, code 6
      16                                ;
      17                                ;	Terminal I/O:
      18                                ;	  EMT 340 = .TTYIN, EMT 341 = .TTYOUT, EMT 350 = .EXIT
      19                                
      20                                	.ASECT
      21 001000                         	.=1000
      22                                
      23 001000 012701  002172          START:	MOV	#HELLO,R1
      24 001004 004767  002002'         	JSR	PC,PUTS
      25 001010 005067  002344'         	CLR	TOTBYT
      26 001014 005067  002346'         	CLR	FILCHN
      27 001020 005067  002350'         	CLR	BLKNUM
      28 001024 005067  002352'         	CLR	BUFIDX
      29                                
      30                                ; Main loop
      31 001030 004767  002134'         WAIT:	JSR	PC,GETLIN	; Get a line
      32 001034 105767  002222'         	TSTB	LINBUF		; Empty?
      33 001040 001773                  	BEQ	WAIT
      34 001042 126727  002222' 000072  	CMPB	LINBUF,#':	; Starts with ':'?
      35 001050 001367                  	BNE	WAIT
      36                                
      37                                	; Check for :END
      38 001052 126727  002223' 000105  	CMPB	LINBUF+1,#'E
      39 001060 001052                  	BNE	NOTEND
      40 001062 126727  002224' 000116  	CMPB	LINBUF+2,#'N
      41 001070 001046                  	BNE	NOTEND
      42 001072 126727  002225' 000104  	CMPB	LINBUF+3,#'D
      43 001100 001042                  	BNE	NOTEND
      44                                
      45                                	; It's :END - flush buffer, close and report
      46 001102 005767  002346'         	TST	FILCHN
      47 001106 001432                  	BEQ	NOFIL
      48                                	; Flush partial block if any
      49 001110 005767  002352'         	TST	BUFIDX
      50 001114 001402                  	BEQ	10$
      51 001116 004767  001564'         	JSR	PC,WRTBLK
      52 001122 004767  001650'         10$:	JSR	PC,CLSFIL
      53 001126 005067  002346'         	CLR	FILCHN
      54                                	; Print DONE:count
      55 001132 012701  002214          	MOV	#MSGDON,R1
      56 001136 004767  002030'         	JSR	PC,PUTS2	; No CRLF
      57 001142 016700  002344'         	MOV	TOTBYT,R0
      58 001146 004767  002042'         	JSR	PC,PRHEX4
      59 001152 012700  000015          	MOV	#15,R0
      60 001156 104341                  	EMT	341
      61 001160 012700  000012          	MOV	#12,R0
      62 001164 104341                  	EMT	341
      63 001166 005067  002344'         	CLR	TOTBYT
      64 001172 000716                  	BR	WAIT
      65                                
      66 001174 012701  002210          NOFIL:	MOV	#MSGERR,R1
      67 001200 004767  002002'         	JSR	PC,PUTS
      68 001204 000711                  	BR	WAIT
      69                                
      70                                NOTEND:	; Check for second colon (data line)
      71 001206 012700  002223          	MOV	#LINBUF+1,R0
      72 001212 004767  001742'         	JSR	PC,FNDCOL
      73 001216 005700                  	TST	R0
      74 001220 001027                  	BNE	ISDATA
      75                                
      76                                	; No second colon = filename - open file
      77 001222 004767  001470'         	JSR	PC,OPNFIL
      78 001226 005700                  	TST	R0
      79 001230 001405                  	BEQ	OPNOK
      80 001232 012701  002210          	MOV	#MSGERR,R1
      81 001236 004767  002002'         	JSR	PC,PUTS
      82 001242 000672                  	BR	WAIT
      83 001244 012767  000001  002346' OPNOK:	MOV	#1,FILCHN
      84 001252 005067  002344'         	CLR	TOTBYT
      85 001256 005067  002350'         	CLR	BLKNUM
      86 001262 005067  002352'         	CLR	BUFIDX
      87 001266 012701  002205          	MOV	#MSGOK,R1
      88 001272 004767  002002'         	JSR	PC,PUTS
      89 001276 000654                  	BR	WAIT
      90                                
      91                                ISDATA:	; Hex data line
      92 001300 005767  002346'         	TST	FILCHN
      93 001304 001463                  	BEQ	NODAT
      94                                	; R0 points after second colon
      95                                	; Skip 4 hex digits + colon (line number)
      96 001306 062700  000005          	ADD	#5,R0
      97 001312 010001                  	MOV	R0,R1		; R1 = pointer to hex data
      98 001314 005004                  	CLR	R4		; Byte count this line
      99                                
     100 001316 112102                  NXTBYT:	MOVB	(R1)+,R2	; Get high nibble char
     101 001320 001445                  	BEQ	DONDAT
     102 001322 120227  000015          	CMPB	R2,#15		; CR?
     103 001326 001442                  	BEQ	DONDAT
     104 001330 120227  000012          	CMPB	R2,#12		; LF?
     105 001334 001437                  	BEQ	DONDAT
     106 001336 120227  000072          	CMPB	R2,#':		; Checksum separator?
     107 001342 001434                  	BEQ	DONDAT
     108 001344 004767  001674'         	JSR	PC,HEXDIG	; Convert to nibble in R0
     109 001350 006300                  	ASL	R0
     110 001352 006300                  	ASL	R0
     111 001354 006300                  	ASL	R0
     112 001356 006300                  	ASL	R0
     113 001360 010003                  	MOV	R0,R3		; Save high nibble
     114 001362 112102                  	MOVB	(R1)+,R2	; Get low nibble char
     115 001364 001423                  	BEQ	DONDAT
     116 001366 004767  001674'         	JSR	PC,HEXDIG
     117 001372 050300                  	BIS	R3,R0		; Combine
     118                                	; Store byte in block buffer
     119 001374 016705  002352'         	MOV	BUFIDX,R5
     120 001400 110065  002374          	MOVB	R0,BLKBUF(R5)
     121 001404 005267  002352'         	INC	BUFIDX
     122 001410 005204                  	INC	R4
     123                                	; Check if block full (512 bytes = 1000 octal)
     124 001412 026727  002352' 001000  	CMP	BUFIDX,#1000
     125 001420 002736                  	BLT	NXTBYT
     126                                	; Block full - write it
     127 001422 004767  001564'         	JSR	PC,WRTBLK
     128 001426 005067  002352'         	CLR	BUFIDX
     129 001432 000731                  	BR	NXTBYT
     130                                
     131 001434 060467  002344'         DONDAT:	ADD	R4,TOTBYT
     132 001440 012701  002205          	MOV	#MSGOK,R1
     133 001444 004767  002002'         	JSR	PC,PUTS
     134 001450 000167  001030'         	JMP	WAIT
     135                                
     136 001454 012701  002210          NODAT:	MOV	#MSGERR,R1
     137 001460 004767  002002'         	JSR	PC,PUTS
     138 001464 000167  001030'         	JMP	WAIT
     139                                
     140                                ; ============ File I/O Subroutines ============
     141                                
     142                                ; OPNFIL - Open/create file for output
     143                                ; Uses filename from LINBUF+1 (after colon)
     144                                ; Returns 0 in R0 on success, non-zero on error
     145                                OPNFIL:
     146                                	; For now, use fixed filename XDATA.BIN
     147                                	; Copy to RAD50 format in FILBLK
     148                                	; RAD50: XDAT = 66424 octal, A<sp><sp> = 200 octal
     149                                	;        BIN  = 6766 octal, <sp><sp><sp> = 0
     150 001470 012767  066424  002364' 	MOV	#66424,FILBLK	; "XDAT"
     151 001476 012767  000200  002366' 	MOV	#200,FILBLK+2	; "A  "
     152 001504 012767  006766  002370' 	MOV	#6766,FILBLK+4	; "BIN"
     153 001512 005067  002372'         	CLR	FILBLK+6	; "   "
     154                                
     155                                	; Set up .ENTER arguments in CHNARA
     156                                	; Format: chan, devhdlr, filename, size
     157 001516 005067  002354'         	CLR	CHNARA		; Channel 0
     158 001522 005067  002356'         	CLR	CHNARA+2	; Default device DK:
     159 001526 012767  002364  002360' 	MOV	#FILBLK,CHNARA+4 ; Filename block
     160 001534 012767  000144  002362' 	MOV	#144,CHNARA+6	; 100 blocks (144 octal)
     161                                
     162                                	; Call .ENTER (EMT 344)
     163 001542 012700  002354          	MOV	#CHNARA,R0
     164 001546 104344                  	EMT	344		; .ENTER
     165 001550 103402                  	BCS	OPNERR
     166 001552 005000                  	CLR	R0		; Success
     167 001554 000207                  	RTS	PC
     168 001556 012700  000001          OPNERR:	MOV	#1,R0		; Error
     169 001562 000207                  	RTS	PC
     170                                
     171                                ; WRTBLK - Write current block to file
     172                                ; Uses BLKBUF, BUFIDX, BLKNUM
     173                                WRTBLK:
     174                                	; Set up .WRITW arguments
     175                                	; Format: chan, buffer, wordcount, block
     176 001564 005067  002354'         	CLR	CHNARA		; Channel 0
     177 001570 012767  002374  002356' 	MOV	#BLKBUF,CHNARA+2 ; Buffer address
     178 001576 016767  002352' 002360' 	MOV	BUFIDX,CHNARA+4	; Byte count
     179 001604 005267  002360'         	INC	CHNARA+4	; Round up
     180 001610 006267  002360'         	ASR	CHNARA+4	; Convert to word count
     181 001614 016767  002350' 002362' 	MOV	BLKNUM,CHNARA+6	; Block number
     182                                
     183                                	; Call .WRITW (EMT 351)
     184 001622 012700  002354          	MOV	#CHNARA,R0
     185 001626 104351                  	EMT	351		; .WRITW
     186 001630 103404                  	BCS	WRTERR
     187 001632 005267  002350'         	INC	BLKNUM		; Next block
     188 001636 005000                  	CLR	R0		; Success
     189 001640 000207                  	RTS	PC
     190 001642 012700  000001          WRTERR:	MOV	#1,R0		; Error
     191 001646 000207                  	RTS	PC
     192                                
     193                                ; CLSFIL - Close the file
     194                                CLSFIL:
     195 001650 005067  002354'         	CLR	CHNARA		; Channel 0
     196                                
     197                                	; Call .CLOSE (EMT 346)
     198 001654 012700  002354          	MOV	#CHNARA,R0
     199 001660 104346                  	EMT	346		; .CLOSE
     200 001662 005067  002350'         	CLR	BLKNUM
     201 001666 005067  002352'         	CLR	BUFIDX
     202 001672 000207                  	RTS	PC
     203                                
     204                                ; ============ Utility Subroutines ============
     205                                
     206                                ; HEXDIG - Convert hex char in R2 to nibble in R0
     207 001674 005000                  HEXDIG:	CLR	R0
     208 001676 120227  000071          	CMPB	R2,#'9
     209 001702 003004                  	BGT	HX1
     210 001704 110200                  	MOVB	R2,R0
     211 001706 162700  000060          	SUB	#'0,R0
     212 001712 000207                  	RTS	PC
     213 001714 120227  000106          HX1:	CMPB	R2,#'F
     214 001720 003004                  	BGT	HX2
     215 001722 110200                  	MOVB	R2,R0
     216 001724 162700  000067          	SUB	#67,R0		; 'A'-10 = 55 = 67 octal
     217 001730 000207                  	RTS	PC
     218 001732 110200                  HX2:	MOVB	R2,R0
     219 001734 162700  000127          	SUB	#127,R0		; 'a'-10 = 87 = 127 octal
     220 001740 000207                  	RTS	PC
     221                                
     222                                ; FNDCOL - Find ':' in string at R0, return ptr after or 0
     223 001742 010001                  FNDCOL:	MOV	R0,R1
     224 001744 112100                  FC1:	MOVB	(R1)+,R0
     225 001746 001411                  	BEQ	FC2
     226 001750 120027  000072          	CMPB	R0,#':
     227 001754 001410                  	BEQ	FC3
     228 001756 120027  000015          	CMPB	R0,#15		; CR
     229 001762 001403                  	BEQ	FC2
     230 001764 120027  000012          	CMPB	R0,#12		; LF
     231 001770 001365                  	BNE	FC1
     232 001772 005000                  FC2:	CLR	R0
     233 001774 000207                  	RTS	PC
     234 001776 010100                  FC3:	MOV	R1,R0
     235 002000 000207                  	RTS	PC
     236                                
     237                                ; PUTS - Print string at R1 with CRLF
     238 002002 112100                  PUTS:	MOVB	(R1)+,R0
     239 002004 001402                  	BEQ	PUTS2E
     240 002006 104341                  	EMT	341
     241 002010 000774                  	BR	PUTS
     242 002012 012700  000015          PUTS2E:	MOV	#15,R0
     243 002016 104341                  	EMT	341
     244 002020 012700  000012          	MOV	#12,R0
     245 002024 104341                  	EMT	341
     246 002026 000207                  	RTS	PC
     247                                
     248                                ; PUTS2 - Print string at R1, no CRLF
     249 002030 112100                  PUTS2:	MOVB	(R1)+,R0
     250 002032 001402                  	BEQ	PUTS2R
     251 002034 104341                  	EMT	341
     252 002036 000774                  	BR	PUTS2
     253 002040 000207                  PUTS2R:	RTS	PC
     254                                
     255                                ; PRHEX4 - Print R0 as 4 hex digits
     256 002042 010046                  PRHEX4:	MOV	R0,-(SP)
     257 002044 010001                  	MOV	R0,R1
     258 002046 000301                  	SWAB	R1
     259 002050 010100                  	MOV	R1,R0
     260 002052 004767  002060'         	JSR	PC,PRHEX2
     261 002056 012600                  	MOV	(SP)+,R0
     262                                	; Fall through
     263                                
     264                                ; PRHEX2 - Print low byte of R0 as 2 hex digits
     265 002060 010046                  PRHEX2:	MOV	R0,-(SP)
     266 002062 006200                  	ASR	R0
     267 002064 006200                  	ASR	R0
     268 002066 006200                  	ASR	R0
     269 002070 006200                  	ASR	R0
     270 002072 042700  177760          	BIC	#177760,R0
     271 002076 004767  002110'         	JSR	PC,PRNIB
     272 002102 012600                  	MOV	(SP)+,R0
     273 002104 042700  177760          	BIC	#177760,R0
     274                                	; Fall through
     275                                
     276                                ; PRNIB - Print nibble in R0
     277 002110 020027  000011          PRNIB:	CMP	R0,#11		; 9 decimal = 11 octal
     278 002114 003003                  	BGT	PN1
     279 002116 062700  000060          	ADD	#'0,R0
     280 002122 000402                  	BR	PN2
     281 002124 062700  000067          PN1:	ADD	#67,R0		; 'A' - 10 = 55 = 67 octal
     282 002130 104341                  PN2:	EMT	341
     283 002132 000207                  	RTS	PC
     284                                
     285                                ; GETLIN - Read line into LINBUF
     286 002134 012701  002222          GETLIN:	MOV	#LINBUF,R1
     287 002140 012702  000120          	MOV	#120,R2		; 80 decimal
     288 002144 104340                  GL1:	EMT	340
     289 002146 110021                  	MOVB	R0,(R1)+
     290 002150 120027  000015          	CMPB	R0,#15
     291 002154 001404                  	BEQ	GL2
     292 002156 120027  000012          	CMPB	R0,#12
     293 002162 001401                  	BEQ	GL2
     294 002164 077211                  	SOB	R2,GL1
     295 002166 105011                  GL2:	CLRB	(R1)
     296 002170 000207                  	RTS	PC
     297                                
     298                                ; ============ Data ============
     299                                
     300 002172    130     106     105  HELLO:	.ASCII	/XFER4 V1.0/
         002175    122     064     040  
         002200    126     061     056  
         002203    060                  
     301 002204    000                  	.BYTE	0
     302 002205    117     113          MSGOK:	.ASCII	/OK/
     303 002207    000                  	.BYTE	0
     304 002210    105     122     122  MSGERR:	.ASCII	/ERR/
     305 002213    000                  	.BYTE	0
     306 002214    104     117     116  MSGDON:	.ASCII	/DONE:/
         002217    105     072          
     307 002221    000                  	.BYTE	0
     308                                	.EVEN
     309                                
     310 002222                         LINBUF:	.BLKB	82.		; Line input buffer
     311 002344 000000                  TOTBYT:	.WORD	0		; Total bytes received
     312 002346 000000                  FILCHN:	.WORD	0		; File channel flag
     313 002350 000000                  BLKNUM:	.WORD	0		; Current block number
     314 002352 000000                  BUFIDX:	.WORD	0		; Index into block buffer
     315                                
     316                                ; RT-11 file I/O areas
     317 002354                         CHNARA:	.BLKW	4		; Channel area (8 bytes)
     318 002364                         FILBLK:	.BLKW	4		; Filename block in RAD50
     319 002374                         BLKBUF:	.BLKB	1000		; 512-byte block buffer
     320                                
     321                                	.END	START
     321                                
