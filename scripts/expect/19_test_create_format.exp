#!/usr/bin/expect -f
#
# 19_test_create_format.exp - Test what format CREATE produces
# and try to build ADVENT with overlays
#

set timeout 300
set port 2322

log_user 1

spawn telnet localhost $port

sleep 3
send "\r"

expect {
    "User:" { }
    "Today's date?" {
        send "1-JAN-92\r"
        expect "Current time?"
        send "12:00\r"
        expect "Start timesharing?"
        send "Y\r"
        expect "Proceed with system startup?"
        send "\r"
        expect "User:"
    }
    timeout { puts ">>> Timeout"; exit 1 }
}

send "1,2\r"
expect "Password:"
send "SYSTEM\r"
expect {
    "Job number to attach to?" { send "\r"; expect -re {\$ } }
    -re {\$ } { }
}

puts "\n>>> Logged in"

# Test what format CREATE produces
puts "\n>>> Testing CREATE file format..."
send "CREATE SY:TESTCRT.TXT\r"
expect "CTRL/Z"
send "TEST LINE\r"
send "\032"
expect -re {\$ }

send "DIR/FULL SY:TESTCRT.TXT\r"
expect -re {\$ }
puts ">>> Check RTS attribute above - looking for RT11 or RSX"

# Also check COPY format
puts "\n>>> Testing COPY format preservation..."
send "COPY SY:\[0,200\]FEDTKB.ODL SY:TESTODL.TMP\r"
expect -re {\$ }

send "DIR/FULL SY:TESTODL.TMP\r"
expect -re {\$ }

# Try to modify TESTODL.TMP using CREATE redirect
puts "\n>>> Trying to create ODL with correct content..."

# First, delete and recreate using CREATE
send "DELETE SY:ADVTEST.ODL\r"
expect -re {\$ }

send "CREATE SY:ADVTEST.ODL\r"
expect "CTRL/Z"

# Send ODL content
send ";\r"
send "; ADVENT.ODL - Overlay descriptor for ADVENT MUD\r"
send ";\r"
send "        .ROOT   ADVENT-LIBR-*(INI,OUT,NOR,CMD,ODD,MSG,BYE,SHT,NPC,PUZ,DSP,FND,TDY)\r"
send "        .NAME   ADVENT\r"
send "ADVENT: .FCTR   SY:ADVENT\r"
send "INI:    .FCTR   SY:ADVINI\r"
send "OUT:    .FCTR   SY:ADVOUT\r"
send "NOR:    .FCTR   SY:ADVNOR\r"
send "CMD:    .FCTR   SY:ADVCMD\r"
send "ODD:    .FCTR   SY:ADVODD\r"
send "MSG:    .FCTR   SY:ADVMSG\r"
send "BYE:    .FCTR   SY:ADVBYE\r"
send "SHT:    .FCTR   SY:ADVSHT\r"
send "NPC:    .FCTR   SY:ADVNPC\r"
send "PUZ:    .FCTR   SY:ADVPUZ\r"
send "DSP:    .FCTR   SY:ADVDSP\r"
send "FND:    .FCTR   SY:ADVFND\r"
send "TDY:    .FCTR   SY:ADVTDY\r"
send "LIBR:   .FCTR   LB:BP2OTS/LB\r"
send "        .END\r"
send "\032"
expect -re {\$ }

# Check the format
puts "\n>>> Checking ADVTEST.ODL format..."
send "DIR/FULL SY:ADVTEST.ODL\r"
expect -re {\$ }

send "TYPE SY:ADVTEST.ODL\r"
expect -re {\$ }

# Try TKB with this ODL
puts "\n>>> Testing TKB with CREATE-made ODL..."
send "TKB\r"
expect "TKB>"

send "SY:ADVTST=SY:ADVTEST.ODL\r"
expect {
    "TKB>" { puts ">>> TKB accepted ODL syntax" }
    "TKB -- *FATAL*-File ADVTEST.ODL has illegal format" {
        puts ">>> CREATE produces RSX format - need RT11"
    }
    "TKB -- *" {
        puts ">>> TKB error"
        exp_continue
    }
    timeout { puts ">>> Timeout" }
}

# Exit TKB
send "/\r"
expect {
    -re {\$ } { }
    "TKB>" { send "/\r"; exp_continue }
}

# Try alternative: Maybe APPEND to an empty file preserves format
puts "\n>>> Trying APPEND approach..."

# Start with RT11-format copy
send "COPY SY:\[0,200\]FEDTKB.ODL SY:ADVENT2.ODL\r"
expect -re {\$ }

# Check format
send "DIR/FULL SY:ADVENT2.ODL\r"
expect -re {\$ }

# Now see if we can somehow truncate and append...
# Actually, let's check if EDT is available
puts "\n>>> Checking for EDT editor..."
send "EDT SY:ADVENT2.ODL\r"
expect {
    "Command:" {
        puts ">>> EDT is available!"
        # Try to edit the file
        send "CHANGE\r"
        expect "?"
        send "*\r"
        expect -re {.+}
        send "EXIT\r"
        expect -re {\$ }
    }
    "Can't find file" {
        puts ">>> EDT not found"
        expect -re {\$ }
    }
    "error" {
        puts ">>> EDT error"
        expect -re {\$ }
    }
    timeout {
        puts ">>> EDT timeout"
        send "\003"
        expect -re {\$ }
    }
}

send "BYE\r"
expect eof

puts "\n>>> Test complete"
