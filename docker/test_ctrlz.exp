#!/usr/bin/expect -f
#
# Test different Ctrl+Z sequences
#

log_user 1
set timeout 20

spawn nc localhost 2323
sleep 2
send "\r"
sleep 2

expect "User:"
send "\[1,2\]\r"
expect "Password:"
send "Digital1977\r"

sleep 2
expect {
    "Job number" { send "\r"; sleep 2; exp_continue }
    -re {\$} {}
}

puts "\n>>> Test 1: Ctrl+Z followed by CR..."
send "DELETE TEST1.TXT\r"
expect -re {\$}
send "CREATE TEST1.TXT\r"
expect "CTRL/Z"
send "Content for test 1\r"
sleep 1
# Ctrl+Z then CR
send "\x1a\r"
sleep 2
expect {
    -re {\$} { puts ">>> Test 1: Got prompt (success?)" }
    timeout { puts ">>> Test 1: Timeout" }
}

# Check 
send "DIR TEST1.TXT\r"
sleep 1
expect -re {\$}

puts "\n>>> Test 2: Ctrl+Z alone with long wait..."
send "DELETE TEST2.TXT\r"
expect -re {\$}
send "CREATE TEST2.TXT\r"
expect "CTRL/Z"
send "Content for test 2\r"
sleep 1
# Ctrl+Z alone
send "\x1a"
sleep 5
expect {
    -re {\$} { puts ">>> Test 2: Got prompt (success?)" }
    timeout { 
        puts ">>> Test 2: Still waiting, sending extra CR"
        send "\r"
        sleep 1
    }
}
expect -re {\$}
send "DIR TEST2.TXT\r"
sleep 1
expect -re {\$}

puts "\n>>> Test 3: Escape key then Ctrl+Z..."
send "DELETE TEST3.TXT\r"
expect -re {\$}
send "CREATE TEST3.TXT\r"
expect "CTRL/Z"
send "Content for test 3\r"
sleep 1
# ESC then Ctrl+Z
send "\x1b\x1a\r"
sleep 2
expect {
    -re {\$} { puts ">>> Test 3: Got prompt" }
    timeout { puts ">>> Test 3: Timeout" }
}
send "DIR TEST3.TXT\r"
sleep 1
expect -re {\$}

puts "\n>>> Showing what was created:"
send "DIR TEST?.TXT\r"
sleep 2
expect -re {\$}

puts "\n>>> Done"
close
