#!/usr/bin/expect -f
#
# Test typing a file into RSTS/E using CREATE command
#

log_user 1
set timeout 30

spawn nc localhost 2323
sleep 2
send "\r"
sleep 2

# Login
expect "User:"
send "\[1,2\]\r"
expect "Password:"
send "Digital1977\r"

sleep 2
expect {
    "Job number" { send "\r"; sleep 2; exp_continue }
    -re {\$} {}
}

puts "\n>>> Logged in, testing CREATE command..."

# Delete any old test file first
send "DELETE TEST.TXT\r"
sleep 1
expect -re {\$}

# Create a simple test file
send "CREATE TEST.TXT\r"
sleep 1
expect {
    "CTRL/Z" {
        puts "\n>>> Got CREATE prompt, typing content..."
    }
    -re {\$} {
        puts "\n>>> ERROR: Got dollar prompt, CREATE may not work"
        close
        exit 1
    }
    timeout {
        puts "\n>>> Timeout waiting for CREATE"
        close
        exit 1
    }
}

# Type some test content - simple ASCII, no special chars
send "Hello from the file transfer test\r"
sleep 1

send "This is line two\r"
sleep 1

send "And line three\r"
sleep 1

# End the file with Ctrl+Z
puts "\n>>> Sending Ctrl+Z to end file..."
send "\x1a"
sleep 2

expect {
    -re {\$} {
        puts "\n>>> File created, verifying..."
    }
    timeout {
        puts "\n>>> Timeout after Ctrl+Z"
    }
}

# Verify the file exists and has content
send "TYPE TEST.TXT\r"
sleep 2

expect {
    "Hello from the file transfer test" {
        puts "\n>>> SUCCESS! File content verified"
    }
    timeout {
        puts "\n>>> Could not verify file content"
    }
}

expect -re {\$}

# Show directory listing
send "DIR TEST.TXT\r"
sleep 2
expect -re {\$}

puts "\n>>> Test complete - CREATE works!"
close
