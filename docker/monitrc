# Monit configuration for ADVENT MUD services
# Monitors and auto-restarts critical services

set daemon 10                   # Check services every 10 seconds
set log /dev/stdout             # Log to stdout for Docker

# Game terminal (ttyd on port 7681)
check process ttyd-game matching "ttyd.*7681"
    start program = "/usr/bin/ttyd -p 7681 -W /opt/advent/game_connect.exp"
    stop program = "/usr/bin/pkill -f 'ttyd.*7681'"
    if failed host 127.0.0.1 port 7681 protocol http then restart
    if 3 restarts within 5 cycles then alert

# Admin terminal (ttyd on port 7682)
check process ttyd-admin matching "ttyd.*7682"
    start program = "/usr/bin/ttyd -p 7682 -W /opt/advent/admin_connect.sh"
    stop program = "/usr/bin/pkill -f 'ttyd.*7682'"
    if failed host 127.0.0.1 port 7682 protocol http then restart
    if 3 restarts within 5 cycles then alert

# Nginx web server
check process nginx matching "nginx: master"
    start program = "/usr/sbin/nginx"
    stop program = "/usr/sbin/nginx -s stop"
    if failed host 127.0.0.1 port 8080 protocol http then restart
    if 3 restarts within 5 cycles then alert

# SIMH emulator
check process simh matching "pdp11"
    if not exist then alert
