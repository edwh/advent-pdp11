#!/usr/bin/expect -f
#
# Test running XFER.SAV
#

log_user 1
set timeout 30

spawn nc localhost 2323
sleep 3
send "\r"
sleep 2

expect {
    "User:" {}
    timeout { puts ">>> Timeout waiting for login"; exit 1 }
}
send "\[1,2\]\r"
expect "Password:"
send "Digital1977\r"

sleep 2
expect {
    "Job number" { send "\r"; sleep 2; exp_continue }
    -re {\$} {}
}

puts "\n>>> Listing \[1,2\] directory for XFER..."
send "DIR \[1,2\]XFER.*\r"
sleep 2
expect -re {\$}

puts "\n>>> Trying to run XFER..."
send "RUN \[1,2\]XFER.SAV\r"
sleep 3
expect {
    "V1.1 Ready" { puts ">>> XFER V1.1 started successfully!" }
    "V1.0 Ready" { puts ">>> XFER V1.0 started (old version)" }
    "Can't find" { puts ">>> ERROR: XFER.SAV not found"; exit 1 }
    "?RSTS" { puts ">>> ERROR: RSTS error running XFER" }
    timeout { puts ">>> Timeout waiting for XFER" }
}

# Try sending a filename
puts "\n>>> Sending filename..."
send ":HELLO.TXT\r"
sleep 2
expect {
    "OK" { puts ">>> File opened successfully!" }
    "ERR" { puts ">>> ERROR opening file" }
    timeout { puts ">>> No response" }
}

# Try sending hex data
puts "\n>>> Sending hex data line..."
send ":0000:48454C4C4F\r"
sleep 2
expect {
    "OK" { puts ">>> Data received OK" }
    "ERR" { puts ">>> ERROR receiving data" }
    timeout { puts ">>> No response" }
}

# End file
puts "\n>>> Sending END..."
send ":END\r"
sleep 2
expect {
    "DONE" { puts ">>> File completed!" }
    "ERR" { puts ">>> ERROR on END" }
    timeout { puts ">>> No response to END" }
}

# Send Ctrl+C to exit
send "\003"
sleep 1

puts "\n>>> Test complete"
close
