#!/usr/bin/expect -f
# Full test of ADVENT game

set timeout 60
log_user 1

spawn nc localhost 2323

expect "Connected to the PDP-11 simulator DZ device"
sleep 2
send "\r"

expect "User:"
send "\[1,2\]\r"

expect -re "\[Pp\]assword"
send "Digital1977\r"

expect {
    "Job number to attach to?" {
        send "\r"
    }
    -re {\$} {}
}

expect -re {\$}

puts "\n\n========== STARTING ADVENT =========="
send "RUN ADVENT\r"

expect {
    "No character loaded" {
        puts "Character creation triggered"
    }
    ">" {}
}

sleep 2

# Try some game commands
puts "\n\n========== TESTING LOOK =========="
send "LOOK\r"
expect {
    "Exits" {
        puts "LOOK command successful"
    }
    timeout {
        puts "LOOK command timeout"
    }
}

sleep 2

puts "\n\n========== TESTING INVENTORY =========="
send "INVENTORY\r"
expect {
    "You are carrying" {
        puts "INVENTORY command successful"
    }
    "carrying nothing" {
        puts "INVENTORY shows empty - that's OK"
    }
    ">" {
        puts "Got prompt after INVENTORY"
    }
    timeout {
        puts "INVENTORY command timeout"
    }
}

sleep 2

puts "\n\n========== TESTING STATUS =========="
send "STATUS\r"
expect {
    ">" {
        puts "STATUS command completed"
    }
    timeout {
        puts "STATUS command timeout"
    }
}

sleep 2

puts "\n\n========== TESTING NORTH =========="
send "NORTH\r"
expect {
    "Exits" {
        puts "NORTH command successful - moved to new room"
    }
    "can't" {
        puts "NORTH blocked"
    }
    ">" {
        puts "Got prompt"
    }
    timeout {
        puts "NORTH command timeout"
    }
}

sleep 2

puts "\n\n========== ALL TESTS COMPLETE =========="
send "BYE\r"
sleep 2
puts "Test finished successfully!"
expect eof
