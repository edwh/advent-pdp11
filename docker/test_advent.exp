#!/usr/bin/expect -f
# Test running full ADVENT game

set timeout 60
log_user 1

spawn nc localhost 2323

expect {
    "Connected to the PDP-11 simulator DZ device" {
        sleep 2
        send "\r"
    }
    timeout {
        puts "Failed to connect"
        exit 1
    }
}

# Try to get login prompt
expect {
    "User:" {
        send "\[1,2\]\r"
    }
    -re {KB[0-9]:} {
        send "HELLO \[1,2\]\r"
    }
    "Bye" {
        send "HELLO \[1,2\]\r"
    }
    -re {\$} {
        # Already logged in
    }
    "Ready" {
        # Already logged in  
    }
    timeout {
        send "\r"
        sleep 2
        send "\r"
        expect "User:"
        send "\[1,2\]\r"
    }
}

# Handle password
expect {
    -re "\[Pp\]assword" {
        send "Digital1977\r"
    }
    -re {\$} {}
    timeout {}
}

# Handle job attachment
expect {
    "Job number to attach to?" {
        send "\r"
    }
    -re {\$} {}
    "Ready" {}
    timeout {}
}

# Wait for prompt
sleep 1
expect {
    -re {\$} {}
    "Ready" {}
    timeout {
        send "\r"
    }
}

# Run ADVENT
puts "\n\n========== Running ADVENT.TSK =========="
send "RUN ADVENT\r"

# Wait for game response
expect {
    -re "already running" {
        puts "\nADVENT is already running elsewhere!"
    }
    -re "Welcome" {
        puts "\nADVENT game started successfully!"
    }
    -re "error|Error|ERROR" {
        puts "\nError running ADVENT!"
    }
    -re "corrupt" {
        puts "\nCharacter corruption detected"
    }
    -re ">" {
        puts "\nAt game prompt"
    }
    timeout {
        puts "\nTimeout waiting for ADVENT response"
    }
}

sleep 3
puts $expect_out(buffer)

# Try the LOOK command
send "LOOK\r"
sleep 2
expect -re {.*}
puts $expect_out(buffer)

# Try to quit the game
send "QUIT\r"
sleep 2
expect -re {.*}
puts $expect_out(buffer)

# Logout
send "BYE\r"
expect eof
