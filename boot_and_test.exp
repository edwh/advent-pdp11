#!/usr/bin/expect -f
# Boot RSTS/E and test ADVENT game

log_user 1
set timeout 180

# Connect to console (2322) to boot
spawn telnet localhost 2322
expect "Connected"
sleep 2

# Try to get to a known state
send "\r"
sleep 3

expect {
    ">>>" {
        puts "\n=== AT SIMH PROMPT - BOOTING ===\n"
        send "boot hk0\r"
        expect {
            "Today's date" { send "1-JAN-92\r" }
            timeout { puts "Timeout waiting for date" }
        }
        expect {
            "Current time" { send "12:00\r" }
            timeout { puts "Timeout waiting for time" }
        }
        # Wait for boot to complete
        expect {
            "Option:" { send "\r"; exp_continue }
            "User:" { puts "\n=== BOOTED ===\n" }
            timeout { puts "Boot timeout" }
        }
    }
    "User:" {
        puts "\n=== ALREADY AT LOGIN ===\n"
    }
    "$ " {
        puts "\n=== ALREADY LOGGED IN ===\n"
    }
    "Today's date" {
        puts "\n=== DATE PROMPT - SYSTEM STARTING ===\n"
        send "1-JAN-92\r"
        expect "Current time"
        send "12:00\r"
        expect {
            "Option:" { send "\r"; exp_continue }
            "User:" { puts "\n=== BOOTED ===\n" }
            timeout { puts "Boot timeout" }
        }
    }
    timeout {
        puts "\n=== TIMEOUT - SYSTEM MAY BE DOWN ===\n"
        send "boot hk0\r"
    }
}

close
sleep 2

# Now connect to terminal 2323
puts "\n=== CONNECTING TO TERMINAL ===\n"
spawn telnet localhost 2323
expect "Connected"
sleep 3
send "\r"
sleep 2

expect {
    "User:" { send "\[1,2\]\r" }
    "$ " { }
    timeout { send "\r"; exp_continue }
}

expect {
    "Password:" { send "Digital1977\r" }
    "$ " { }
}

expect {
    "Job number to attach to?" { send "\r" }
    "$ " { }
}

expect "$ "
puts "\n=== LOGGED IN - TESTING ADVENT ===\n"

# Check files exist
send "DIR DM1:\[1,2\]ADVENT.TSK\r"
expect "$ "

send "DIR DM1:\[1,2\]ADVENT.DTA\r"
expect "$ "

# Run the game
puts "\n=== RUNNING ADVENT ===\n"
send "RUN DM1:\[1,2\]ADVENT\r"

set timeout 60
expect {
    "Welcome" {
        puts "\n************************************\n"
        puts "*** SUCCESS - GAME STARTED! ***"
        puts "************************************\n"
    }
    "INITIALIZING" {
        puts "\n*** GAME INITIALIZING ***\n"
        exp_continue
    }
    ">" {
        puts "\n*** GOT GAME PROMPT ***\n"
    }
    -re "\\?.*at line" {
        puts "\n*** BASIC ERROR ***\n"
    }
    -re "\\?.*" {
        puts "\n*** ERROR ***\n"
    }
    timeout {
        puts "\n*** TIMEOUT ***\n"
    }
}

puts "\n=== TEST COMPLETE ===\n"
