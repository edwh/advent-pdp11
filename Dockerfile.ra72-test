# RA72 Boot Test - RSTS/E V10.1 from Tom Lake
#
# Simple test container to verify the RA72 disk image boots
#
# Build: docker build -f Dockerfile.ra72-test -t advent-ra72-test .
# Run:   docker run -it --name advent-ra72-test -p 2322:2322 -p 2323:2323 advent-ra72-test

FROM debian:bookworm-slim AS simh-builder

RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    git \
    libpcap-dev \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /src
RUN git clone --branch v4.0-Beta-1 --depth 1 https://github.com/simh/simh.git && \
    cd simh && \
    yes n | make pdp11

# --- Runtime image ---
FROM debian:bookworm-slim

RUN apt-get update && apt-get install -y --no-install-recommends \
    bash \
    expect \
    netcat-openbsd \
    libpcap0.8 \
    && rm -rf /var/lib/apt/lists/*

COPY --from=simh-builder /src/simh/BIN/pdp11 /usr/local/bin/pdp11

WORKDIR /opt/rsts
RUN mkdir -p disks

# Copy RA72 disk image (1GB)
COPY simh/Disks/ra72/rstse_10_ra72.dsk /opt/rsts/disks/

# Copy SIMH config
COPY simh/pdp11_ra72.ini /opt/rsts/pdp11.ini

# Fix paths in config to match container layout
RUN sed -i 's|Disks/ra72/rstse_10_ra72.dsk|disks/rstse_10_ra72.dsk|' /opt/rsts/pdp11.ini

EXPOSE 2322 2323

# Run SIMH directly (interactive boot)
CMD ["/usr/local/bin/pdp11", "/opt/rsts/pdp11.ini"]
