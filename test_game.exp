#!/usr/bin/expect -f
# Test if ADVENT game starts after data files are in place

log_user 1
set timeout 120

spawn telnet localhost 2323
expect "Connected"
sleep 3
send "\r"
sleep 2

expect {
    "User:" { send "\[1,2\]\r" }
    timeout { send "\r"; exp_continue }
}
expect "Password:" { send "Digital1977\r" }

expect {
    "Job number to attach to?" { send "\r" }
    "$ " { }
}

expect "$ "
puts "\n=== LOGGED IN ===\n"

# Check data files
send "DIR DM1:\[1,2\]ADVENT.*\r"
expect "$ "

puts "\n=== TRYING TO RUN ADVENT ===\n"
send "RUN DM1:\[1,2\]ADVENT\r"

set timeout 30
expect {
    "Welcome" {
        puts "\n*** GAME STARTED - Welcome message! ***\n"
        # Try to look around
        sleep 2
        send "LOOK\r"
        expect {
            ">" { puts "Got game prompt!" }
            timeout { puts "Timeout after LOOK" }
        }
    }
    "INITIALIZING" {
        puts "\n*** GAME INITIALIZING! ***\n"
        expect {
            "Welcome" { puts "Got welcome after init" }
            ">" { puts "Got prompt after init" }
            timeout { puts "Timeout after init" }
        }
    }
    ">" {
        puts "\n*** GOT GAME PROMPT ***\n"
        send "LOOK\r"
        expect ">"
    }
    -re "\\?.*" {
        puts "\n*** ERROR: ***\n"
        puts $expect_out(0,string)
    }
    "Not a valid device" {
        puts "\n*** DEVICE ERROR ***\n"
    }
    "Can't find file" {
        puts "\n*** FILE NOT FOUND ***\n"
    }
    timeout {
        puts "\n*** TIMEOUT waiting for game ***\n"
    }
}

sleep 2
puts "\n=== TEST COMPLETE ===\n"
